<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>{% block title %}DonerCraft{% endblock %}</title>

  <!-- Tailwind (быстрый вариант) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="/static/site.css" />

</head>

<body class="bg-gray-50 min-h-screen">
  <header class="w-full bg-white border-b border-gray-200">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 h-16 flex items-center justify-between">
      <!-- Лого -->
      <a class="whitespace-nowrap" href="/"><img src="/static/img/logo.png" class="h-20 w-auto" alt="Логотип"></img></a>

      <nav class="flex items-center gap-2 sm:gap-3">
        <!-- Обычные кнопки: glow появляется ТОЛЬКО при hover -->
        <a href="/base/" class="relative inline-flex items-center group">
          <span
            class="pointer-events-none absolute -inset-1 rounded-full bg-gradient-to-r from-orange-500 via-amber-300 to-yellow-400 blur opacity-0 transition duration-500 group-hover:opacity-100">
          </span>
          <span
            class="relative rounded-full bg-white px-4 py-2 text-sm font-medium text-gray-900 ring-1 ring-gray-900/10 hover:bg-gray-50">
            Главное
          </span>
        </a>

        <a href="/builder/" class="relative inline-flex items-center group">
          <span
            class="pointer-events-none absolute -inset-1 rounded-full bg-gradient-to-r from-orange-500 via-amber-300 to-yellow-400 blur opacity-0 transition duration-500 group-hover:opacity-100">
          </span>
          <span
            class="relative rounded-full bg-white px-4 py-2 text-sm font-medium text-gray-900 ring-1 ring-gray-900/10 hover:bg-gray-50">
            Конструктор
          </span>
        </a>

        <a href="/builder/" class="relative inline-flex items-center group">
          <span
            class="pointer-events-none absolute -inset-1 rounded-full bg-gradient-to-r from-orange-500 via-amber-300 to-yellow-400 blur opacity-0 transition duration-500 group-hover:opacity-100">
          </span>
          <span
            class="relative rounded-full bg-white px-4 py-2 text-sm font-medium text-gray-900 ring-1 ring-gray-900/10 hover:bg-gray-50">
            Меню
          </span>
        </a>

        <a href="/builder/" class="relative inline-flex items-center group">
          <span
            class="pointer-events-none absolute -inset-1 rounded-full bg-gradient-to-r from-orange-500 via-amber-300 to-yellow-400 blur opacity-0 transition duration-500 group-hover:opacity-100">
          </span>
          <span
            class="relative rounded-full bg-white px-4 py-2 text-sm font-medium text-gray-900 ring-1 ring-gray-900/10 hover:bg-gray-50">
            Контакты
          </span>
        </a>

        <a href="/builder/" class="relative inline-flex items-center group">
          <span
            class="pointer-events-none absolute -inset-1 rounded-full bg-gradient-to-r from-orange-500 via-amber-300 to-yellow-400 blur opacity-0 transition duration-500 group-hover:opacity-100">
          </span>
          <span
            class="relative rounded-full bg-white px-4 py-2 text-sm font-medium text-gray-900 ring-1 ring-gray-900/10 hover:bg-gray-50">
            О нас
          </span>
        </a>

        <!-- Корзина: остается оранжевой ВСЕГДА + усиленное свечение на hover -->
        <a href="/cart/" class="relative inline-flex items-center group">
          <span
            class="pointer-events-none absolute -inset-1 rounded-full bg-gradient-to-r from-orange-500 via-amber-300 to-yellow-400 blur opacity-30 transition duration-500 group-hover:opacity-100">
          </span>
          <span
            class="relative rounded-full bg-orange-500 px-5 py-2 text-white text-sm font-semibold shadow hover:bg-orange-600">
            Корзина
          </span>
        </a>

        <a href="/admin/" class="relative inline-flex items-center group">
          <span
            class="pointer-events-none absolute -inset-1 rounded-full bg-gradient-to-r from-orange-500 via-amber-300 to-yellow-400 blur opacity-0 transition duration-500 group-hover:opacity-100">
          </span>
          <span
            class="relative rounded-full bg-white px-4 py-2 text-sm font-medium text-gray-900 ring-1 ring-gray-900/10 hover:bg-gray-50">
            Админ
          </span>
        </a>
      </nav>
    </div>
  </header>

  <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    {% block content %}{% endblock %}
  </main>

  <script>
  // ===== CSRF =====
  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
      const cookies = document.cookie.split(';');
      for (let i = 0; i < cookies.length; i++) {
        const cookie = cookies[i].trim();
        if (cookie.substring(0, name.length + 1) === (name + '=')) {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }
  window.CSRF_TOKEN = getCookie('csrftoken');

  // ===== Modal open/close =====
  const modalContainer = document.getElementById("modal_container");
  const closeBtn = document.getElementById("close");

  function openModal() {
    modalContainer.classList.add("show");
    modalContainer.setAttribute("aria-hidden", "false");
    document.body.classList.add("no-scroll");
  }

  function closeModal() {
    modalContainer.classList.remove("show");
    modalContainer.setAttribute("aria-hidden", "true");
    document.body.classList.remove("no-scroll");
  }

  if (closeBtn) closeBtn.addEventListener("click", closeModal);

  // клик по фону закрывает
  if (modalContainer) {
    modalContainer.addEventListener("click", (e) => {
      if (e.target === modalContainer) closeModal();
    });
  }

  // Esc закрывает
  document.addEventListener("keydown", (e) => {
    if (e.key === "Escape" && modalContainer?.classList.contains("show")) closeModal();
  });

  // ===== Builder state =====
  const modalBuilder = document.getElementById("modalBuilder");
  const addonsGrid = document.getElementById("addonsGrid");
  const modalTotal = document.getElementById("modalTotal");
  const modalAddToCart = document.getElementById("modalAddToCart");

  let selectedAddons = new Set();
  let selectedBase = "trad";
  let selectedSize = 20;
  let basePrice = 0;
  let productId = null;

  function setActive(groupEl, selector, activeBtn) {
    if (!groupEl || !activeBtn) return;
    groupEl.querySelectorAll(selector).forEach(b => b.classList.remove("is-active"));
    activeBtn.classList.add("is-active");
  }

  function recalcTotal() {
    if (!addonsGrid || !modalTotal || !modalAddToCart) return 0;

    let addonsSum = 0;
    selectedAddons.forEach(id => {
      const el = addonsGrid.querySelector(`[data-addon-id="${id}"]`);
      addonsSum += el ? Number(el.dataset.price || 0) : 0;
    });

    const total = Number(basePrice) + addonsSum;
    modalTotal.textContent = total + " тг.";
    modalAddToCart.textContent = `В корзину за ${total} тг.`;
    return total;
  }

  // ===== ОТКРЫТИЕ МОДАЛКИ ТОЛЬКО ЧЕРЕЗ .js-open-modal =====
  document.addEventListener("click", (e) => {
    const btn = e.target.closest(".js-open-modal");
    if (!btn) return;

    // 1) открыть окно
    openModal();

    // 2) взять цену и product_id из кнопки
    productId = Number(btn.dataset.productId || 0);
    basePrice = Number(btn.dataset.basePrice || 0);

    // 3) сброс допов
    selectedAddons = new Set();
    addonsGrid?.querySelectorAll(".addon-card").forEach(c => c.classList.remove("is-selected"));

    // 4) дефолты
    selectedBase = "trad";
    selectedSize = 20;

    // 5) подсветка кнопок
    const baseSeg = modalBuilder?.querySelector(".seg--base");
    const sizeSeg = modalBuilder?.querySelector(".seg--size");
    setActive(baseSeg, ".seg__btn", baseSeg?.querySelector(`[data-base="${selectedBase}"]`));
    setActive(sizeSeg, ".seg__btn", sizeSeg?.querySelector(`[data-size="${selectedSize}"]`));

    // 6) показать стартовую цену (1500)
    recalcTotal();
  });

  // ===== Выбор размера/основы =====
  modalBuilder?.addEventListener("click", (e) => {
    const sizeBtn = e.target.closest(".seg--size .seg__btn");
    if (sizeBtn) {
      selectedSize = Number(sizeBtn.dataset.size);
      setActive(modalBuilder.querySelector(".seg--size"), ".seg__btn", sizeBtn);
      recalcTotal();
      return;
    }

    const baseBtn = e.target.closest(".seg--base .seg__btn");
    if (baseBtn) {
      selectedBase = baseBtn.dataset.base;
      setActive(modalBuilder.querySelector(".seg--base"), ".seg__btn", baseBtn);
      recalcTotal();
    }
  });

  // ===== Выбор допов =====
  addonsGrid?.addEventListener("click", (e) => {
    const card = e.target.closest(".addon-card");
    if (!card) return;

    const id = card.dataset.addonId;
    if (selectedAddons.has(id)) {
      selectedAddons.delete(id);
      card.classList.remove("is-selected");
    } else {
      selectedAddons.add(id);
      card.classList.add("is-selected");
    }
    recalcTotal();
  });

  // ===== Добавить в корзину =====
  modalAddToCart?.addEventListener("click", async () => {
    if (!productId) return;

    const payload = {
      item_type: "PRODUCT",
      product_id: productId,
      quantity: 1,
      addons: Array.from(selectedAddons),
      base: selectedBase,
      size: selectedSize
    };

    const res = await fetch("/api/cart/add/", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "X-CSRFToken": window.CSRF_TOKEN || ""
      },
      body: JSON.stringify(payload)
    });

    const data = await res.json().catch(() => ({}));

    if (!res.ok || !data.ok) {
      console.log("cart/add error:", data);
      return;
    }

    window.location.href = "/cart/";
  });
</script>
  {% block scripts %}{% endblock %}
</body>
</html>
